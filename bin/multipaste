#!/usr/bin/env python2
# -*- coding: UTF-8 -*-

import re, sys, os, imghdr, urllib, urllib2, socket

notifyargs = "notify-send -t 5000 -i gtk-dialog-info"
socket.setdefaulttimeout(10)

if len(sys.argv)==2:
    string = sys.argv[1].strip()
elif not sys.stdin.isatty():
    string = sys.stdin.read().strip()
    if not string: 
        string = os.popen('xsel -o').read().strip()

def shorturl(longUrl):
    url = "http://api.j.mp/v3/shorten?"
    login = "lainme"
    apiKey = "R_cf1f577753e518dacf31e2b8c65968d4"
    format = "txt"

    data = urllib.urlencode({"login": login, "apiKey": apiKey, "longUrl": longUrl, "format": format})
    try:
        outstr = urllib2.urlopen(url, data).read().strip()
        return outstr
    except:
        return False

def pasteimg(imgpath):
    url = "http://api.imgur.com/2/upload.xml"
    key = "67e9a32075b72746ae5103bc8f909cbb"
    curlstr = "curl -s -F 'image=@%s' -F 'key=%s' %s" %(imgpath, key, url)

    try:
        outstr = os.popen(curlstr).read()
        #result = re.search("<original>([^<]*)", outstr).group(1)
        return outstr
        #return result
    except:
        return False

def pastefile(string):
    url = "http://paste.pocoo.org/"
    
    if os.path.isfile(string):
        f = open(string)
        code = f.read()
        f.close()
    else:
        code = string
    
    language = os.popen("zenity --title='语言' --entry --text='输入代码语言'  --entry-text='text'").read().strip()
    
    data = urllib.urlencode({"language": language, "code": code})
    try:
        request = urllib2.Request(url, data)
        outstr = urllib2.urlopen(request).geturl()
        return outstr
    except:
        return False

if string=="":
    sys.exit()
elif re.match("http", string):
    result = shorturl(string)
elif os.path.isfile(string) and imghdr.what(string):
    result = pasteimg(string)
else:
    result = pastefile(string)

if result:
    os.popen("echo '%s' | xsel -i" %(result))
    os.popen("echo '%s' | xsel -i -b" %(result))
    os.system("%s '上传成功：' '%s'" %(notifyargs, result))
else:
    os.system("%s '上传出错'" %(notifyargs))
